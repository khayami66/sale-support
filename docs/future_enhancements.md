# メルカリ出品サポートシステム - 今後の機能拡張計画

## 概要

このドキュメントは、今後追加・改善予定の機能をまとめたものです。
各機能の詳細仕様は、実装前に確定させます。

---

## 1. 複数画像対応によるAI推定精度向上

### 現状の課題
- 1枚の画像からAIが推定しているため、推定精度が高くない
- その後の入力・修正の手間が多い
- 複数画像を送ると、画像1枚ごとに返信が来てしまう（3枚送ると3回返信）

### 改善内容
- LINEで複数枚の画像を一度に送信できるようにする
- 複数画像をAIに渡すことで推定精度を向上
- 修正等の入力の手間を削減

### 採用方式：B. 価格・管理番号で確定

**方式の説明：**
- 画像を連続で送っても、返信は控えめにする（または最後の1回のみ）
- 「880 222」（価格・管理番号）を送った時点で画像受付を終了し、次のステップへ進む

**改善後のフロー：**
```
1. [ユーザー] 画像を複数枚送信（3枚）
2. [システム] 「画像を受け付けました（3枚）。
              続けて画像を送るか、「仕入れ価格 管理番号」を送信してください」
              ※返信は最後の1回のみ
3. [ユーザー] 880 222
4. [システム] カテゴリ判定 → 実寸入力の案内
   ...以降は現在と同じ
```

**メリット：**
- 現在のフローに近い
- ユーザーの追加操作が不要
- 明確なトリガー（価格・管理番号送信）で次へ進む

### 実装方針
- [ ] 画像受信時の返信を抑制（毎回返信しない）
- [ ] 複数画像がセッションに蓄積される仕組みは既存を活用
- [ ] 価格・管理番号受信時に、蓄積された全画像を使って処理開始
- [ ] 画像の最大枚数：5枚まで（現在のコードと同じ）

### ステータス
仕様確定 → 実装待ち

---

## 2. スプレッドシートへの画像保存

### 現状の課題
- 画像がスプレッドシートに保存されていない
- 商品の確認時に画像を参照できない

### 改善内容
- 商品画像をクラウドにアップロード
- スプレッドシートからIMAGE関数で表示、またはURLリンクで参照可能にする

### 検討事項
- [ ] 画像ホスティング先の選定
  - A) Cloudinary（別途アカウント作成が必要）
  - B) Google共有ドライブ（組織アカウントが必要）
  - C) 画像URLのみ保存（実際の画像は別管理）
  - D) その他のサービス

### 過去の試行
- Google Drive APIでの実装を試みたが、サービスアカウントのストレージ制限により断念

### ステータス
未着手

---

## 3. 販売管理機能の追加

### 現状の課題
- 商品情報のみの管理で、販売後の情報管理ができていない
- 利益計算が手動

### 改善内容
- スプレッドシートで販売価格・利益などを管理できるようにする

### 採用方式：A. 既存シートにカラム追加

**追加カラム：**
| カラム名 | 説明 | 備考 |
|---------|------|------|
| ステータス | 出品中/売却済み | 商品登録時に「出品中」、売却時に「売却済み」に自動変更 |
| 販売日 | 実際に売れた日 | 売却処理時に自動設定 |
| 実際の販売価格 | 値下げ後の販売価格 | ユーザー入力 |
| 実際の送料 | 実際にかかった送料 | ユーザー入力 |
| 手数料 | 販売価格 × 10% | 自動計算 |
| 利益 | 販売価格 - 仕入価格 - 送料 - 手数料 | 自動計算 |

### ステータス
実装中

---

## 4. 販売完了時のLINE入力機能

### 現状の課題
- 商品が売れた際の情報更新が手動
- スプレッドシートを直接編集する必要がある

### 改善内容
- 商品が売れた際に、LINEから以下の情報を送信できるようにする
  - 商品管理番号
  - 販売価格
  - 送料

### 採用方式：2ステップ対話形式

**フロー：**
```
1. [ユーザー] 売却
2. [システム] 売却情報を入力してください。
              「管理番号 販売価格 送料」
              例: 「215 3000 700」
3. [ユーザー] 215 3000 700
4. [システム] 売却を記録しました。

              管理番号: 215
              販売価格: 3,000円
              送料: 700円
              手数料: 300円
              利益: 1,120円

              ※スプレッドシートを更新しました
```

### 実装内容
- [x] 入力形式の確定（2ステップ対話形式）
- [ ] 新しいセッション状態 `WAITING_SALE_INFO` を追加
- [ ] 「売却」コマンドの処理
- [ ] 管理番号でスプレッドシートを検索
- [ ] 販売情報の更新（ステータス、販売日、販売価格、送料、手数料、利益）
- [ ] 商品が見つからない場合のエラーハンドリング

### ステータス
実装中

---

## 優先度（未確定）

| 優先度 | 機能 | 理由 |
|-------|------|------|
| ? | 複数画像対応 | 日常的な入力負担軽減 |
| ? | 販売完了入力 | 販売管理の効率化 |
| ? | 販売管理機能 | 利益把握に必要 |
| ? | 画像保存 | あると便利だが必須ではない |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-17 | 初版作成。4つの機能拡張計画を記録 |
