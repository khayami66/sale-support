# メルカリ出品サポートシステム 要件定義書

## 1. システム概要

### 1.1 目的
LINEボットを通じて古着の出品作業を効率化するシステム。
画像とテキスト情報から商品名・商品説明・価格提案を自動生成し、メルカリ出品の手間を削減する。

### 1.2 主要機能
1. **商品特徴の自動推定**：画像＋テキストからブランド・カテゴリ・色などを推定
2. **確認・修正フロー**：AIの推定結果をユーザーが確認・修正できる
3. **3種類の価格戦略**：高利益重視／バランス／回転重視から選択
4. **商品情報の自動生成**：商品名・説明文・ハッシュタグを生成
5. **データ保存**：Googleスプレッドシートに1商品＝1行で保存

---

## 2. システムフロー

```
[ユーザー] LINE で画像＋テキストを送信
    │
    ▼
[Step1] AI が商品特徴を推定
    │  - ブランド、カテゴリ、アイテム種別、性別
    │  - サイズ、色、デザイン特徴、状態
    │  - 不明な項目は「UNKNOWN」とする
    │
    ▼
[Step2] 確認用サマリーをLINEに返信
    │  例：
    │  1. ブランド：adidas
    │  2. カテゴリ：トップス
    │  3. アイテム：パーカー
    │  4. 性別：メンズ
    │  5. サイズ：L
    │  6. 色：ネイビー
    │  7. デザイン：ロゴ刺繍
    │
    │  戦略を選択してください：
    │  A. 高利益重視
    │  B. バランス
    │  C. 回転重視
    │
    ▼
[Step3] ユーザーが修正＋戦略選択
    │  - 修正がない場合：「戦略B」などと送信
    │  - 修正がある場合：「1 NIKE」「3 スウェット」など番号＋修正内容
    │  - 最後に戦略を選択して確定
    │
    ▼
[Step4] 最終的な商品情報を生成
    │  - 商品名（40字以内）
    │  - 商品説明（テンプレート適用）
    │  - ハッシュタグ（10個前後）
    │  - 価格提案（戦略に応じた3種の価格）
    │
    ▼
[Step5] LINEに返信 ＋ Googleスプレッドシートに保存
```

---

## 3. 入力仕様

### 3.1 画像
- **枚数**：1〜5枚
- **用途**：全画像をAIに渡して解析
- **タグ写真**：素材確認用に含めることがある（読み取れない場合は素材省略）

### 3.2 テキスト入力

ユーザーは以下の情報をLINEで送信する：

| 項目 | 必須 | 形式例 |
|------|------|--------|
| 仕入れ価格 | ○ | `仕入れ 814円` `仕入れ814` |
| 性別 | ○ | `メンズ` `レディース` `ユニセックス` |
| サイズ | ○ | `L` `XL` `フリー` |
| 商品管理番号 | ○ | `商品管理番号：215` `管理番号215` |
| 実寸 | ○ | 下記参照 |
| 年代 | △ | `90s` `2000年代`（不明なら省略可） |
| 補足情報 | △ | 自由記述 |

### 3.3 実寸フォーマット

柔軟にパースする。以下のいずれの形式でも対応：

**トップス**
```
実寸 着丈66 身幅55 肩幅48 袖丈60
着丈:66cm 身幅:55cm 肩幅:48cm 袖丈:60cm
着丈66
身幅55
肩幅48
袖丈60
```

**パンツ**
```
実寸 ウエスト64 股下64 裾幅13 股上28
```

**セットアップ**
```
実寸 トップス着丈60 身幅51 肩幅38 袖丈60 パンツウエスト72 股下77 裾幅19 股上27
```

---

## 4. 出力仕様

### 4.1 商品名
- **文字数**：40字以内
- **構成**：[年代] + ブランド + アイテム + 特徴
- **例**：`90s adidas トラックジャケット 刺繍ロゴ ネイビー L`

### 4.2 商品説明

カテゴリ別のテンプレートを使用。差し替え箇所のみAIが生成。

**差し替え対象：**
- ブランド名
- アイテムの説明文（1〜2文）
- 色
- 素材（タグから読み取れた場合のみ。読み取れない場合は省略）
- 実寸値
- ハッシュタグ
- 商品管理番号

**固定部分：**
- 【状態について】セクション全体
- 注意書き・免責事項
- 「#古着屋883」のタグ
- フッター文言

### 4.3 テンプレート

#### トップス用
```
【商品について】
{ブランド}の{色}{アイテム}です。{説明文1〜2文}

【実寸】
着丈：{着丈}cm
身幅：{身幅}cm
肩幅：{肩幅}cm
袖丈：{袖丈}cm
※採寸は素人寸法なので、ご理解の程よろしくお願い致します（2〜4センチ誤差がある場合があります）。

【状態について】
特に目立った傷や汚れのないお品物です。古着故、多少の使用感はございますが、普段古着を着られる方でしたら、気にならずお使い頂ける一枚かと思います。
※商品名に書いている年代とは違う場合もあります、ご理解の上ご購入ください。
※多少の汚れ・破れがあっても、目立っていなければ、目立った傷汚れなしとして、販売します。目立った傷汚れ等なしと選択していても、古着ですので価値観によっては「傷・汚れ」と思われてしまう場合がございます。
気になるところがある際は、具体的にコメントをお願いいたします。
また、写真写りやシワ等も写真の撮り方で実物と少々違う場合がありますので、ご了承ください。

★上記、ご理解の上でご購入よろしくお願いいたします★

{ハッシュタグ}

#古着屋883　←他の商品もご覧くださいね‼️

最後までお読みいただきありがとうございました！
気持ちの良いお取引をどうぞよろしくお願い致します。

商品管理番号：{管理番号}
```

#### パンツ用
```
【商品について】
{ブランド}の{アイテム}です。{色}で{説明文1〜2文}

【実寸】
ウエスト：{ウエスト}cm
股下：{股下}cm
裾幅：{裾幅}cm
股上：{股上}cm
※採寸は素人寸法なので、ご理解の程よろしくお願い致します（2〜4センチ誤差がある場合があります）。

【状態について】
（トップスと同じ）

★上記、ご理解の上でご購入よろしくお願いいたします★

{ハッシュタグ}

#古着屋883　←他の商品もご覧くださいね‼️

最後までお読みいただきありがとうございました！
気持ちの良いお取引をどうぞよろしくお願い致します。

商品管理番号：{管理番号}
```

#### セットアップ用
```
【商品について】
{ブランド}の{アイテム}のセットアップです。{説明文1〜2文}

【実寸】
◯トップス
着丈：{着丈}cm
身幅：{身幅}cm
肩幅：{肩幅}cm
袖丈：{袖丈}cm
◯パンツ
ウエスト：{ウエスト}cm
股下：{股下}cm
裾幅：{裾幅}cm
股上：{股上}cm
※採寸は素人寸法なので、ご理解の程よろしくお願い致します（2〜4センチ誤差がある場合があります）。

【状態について】
（トップスと同じ）

★上記、ご理解の上でご購入よろしくお願いいたします★

{ハッシュタグ}

#古着屋883　←他の商品もご覧くださいね‼️

最後までお読みいただきありがとうございました！
気持ちの良いお取引をどうぞよろしくお願い致します。

商品管理番号：{管理番号}
```

### 4.4 ハッシュタグ
- **個数**：10個前後
- **必須タグ**：ブランド名、アイテム名、色
- **固定タグ**：`#古着屋883`（商品タグとは別にフッターに記載）

### 4.5 価格提案

#### 計算式

**最低価格（これ以下では売らない）**
```
最低価格 = (仕入価格 + 送料 + 200) ÷ 0.9
※送料は一律500円
※200円が最低利益ライン
```

**例：仕入れ800円の場合**
```
(800 + 500 + 200) ÷ 0.9 = 1,667円 → 1,670円（切り上げ）
```

#### 戦略別の価格提案

| 戦略 | スタート価格 | 想定販売価格 | 値下げ許容ライン |
|------|-------------|-------------|----------------|
| 高利益重視 | 相場上限〜やや上 | 相場上位 | 相場中央 |
| バランス | 相場中央〜やや上 | 相場中央 | 相場下位 |
| 回転重視 | 相場中央〜やや下 | 相場下位 | 最低価格 |

※v1ではAIが一般的な相場感から推測。v2以降で販売データを活用。

---

## 5. AI推定ルール

### 5.1 推定対象項目

| 項目 | 推定方法 | 不明時の扱い |
|------|---------|-------------|
| ブランド | 画像（ロゴ・タグ）から推定 | `UNKNOWN` |
| カテゴリ | トップス／パンツ／セットアップ | 必須（推定必須） |
| アイテム種別 | パーカー／スウェット／Tシャツ等 | `UNKNOWN` |
| 性別 | ユーザー入力を優先 | ユーザー入力必須 |
| サイズ | ユーザー入力を優先 | ユーザー入力必須 |
| 色 | 画像から推定 | `UNKNOWN` |
| デザイン特徴 | 画像から推定（刺繍/プリント/無地等） | 省略可 |
| 素材 | タグ写真から読み取り | 省略（記載しない） |

### 5.2 AIへの指示（誤認識防止）

1. **確信度が低い場合は`UNKNOWN`を使用**
   - ブランドロゴが見えない・不鮮明 → `UNKNOWN`
   - 色が判別しにくい → `UNKNOWN`

2. **情報を盛らない**
   - 画像に写っていない特徴を推測で追加しない
   - 「おそらく〜」「〜かもしれない」は使わない

3. **セット商品の誤認識防止**
   - 1枚の画像に複数アイテムが写っていても、ユーザー指定がない限り単品として扱う
   - セットアップはユーザーが明示した場合のみ

4. **存在しない情報を書かない**
   - タグが読めない → 素材は省略
   - 年代不明 → 商品名から年代を省略

---

## 6. 状態管理

### 6.1 セッション管理
- **方式**：1ユーザー＝1商品ずつ処理（シンプル）
- 前の商品の処理が完了するまで、新しい商品の登録は受け付けない
- タイムアウト：30分間操作がなければセッションをリセット

### 6.2 状態遷移

```
[IDLE] 待機状態
   │
   │ 画像＋テキスト受信
   ▼
[CONFIRMING] 確認待ち状態
   │  - 確認サマリーを表示中
   │  - 修正入力 or 戦略選択を待つ
   │
   │ 戦略選択（確定）
   ▼
[GENERATING] 生成中
   │
   │ 生成完了
   ▼
[IDLE] 待機状態に戻る
```

---

## 7. データ保存（Googleスプレッドシート）

### 7.1 カラム構成

| カラム名 | 説明 | 例 |
|---------|------|-----|
| 管理番号 | 商品管理番号 | 215 |
| 登録日時 | システム登録日時 | 2024-01-15 14:30:00 |
| 仕入れ価格 | 仕入れ値 | 814 |
| ブランド | 確定したブランド | adidas |
| カテゴリ | トップス/パンツ/セットアップ | トップス |
| アイテム | アイテム種別 | パーカー |
| 性別 | メンズ/レディース/ユニセックス | メンズ |
| サイズ | S/M/L/XL/フリー等 | L |
| 色 | 色 | ネイビー |
| デザイン特徴 | 刺繍/プリント/無地等 | ロゴ刺繍 |
| 年代 | 90s/2000年代等 | 90s |
| 戦略 | 高利益/バランス/回転重視 | バランス |
| 商品名 | 生成された商品名 | 90s adidas パーカー... |
| 商品説明 | 生成された説明文全文 | 【商品について】... |
| ハッシュタグ | 生成されたタグ | #adidas #パーカー... |
| スタート価格 | 提案されたスタート価格 | 3500 |
| 想定販売価格 | 提案された想定販売価格 | 3000 |
| 値下げ許容ライン | 提案された下限価格 | 2500 |
| 最低価格 | 計算された最低価格 | 1670 |
| 実寸_着丈 | 着丈（トップス/セットアップ） | 66 |
| 実寸_身幅 | 身幅（トップス/セットアップ） | 55 |
| 実寸_肩幅 | 肩幅（トップス/セットアップ） | 48 |
| 実寸_袖丈 | 袖丈（トップス/セットアップ） | 60 |
| 実寸_ウエスト | ウエスト（パンツ/セットアップ） | - |
| 実寸_股下 | 股下（パンツ/セットアップ） | - |
| 実寸_裾幅 | 裾幅（パンツ/セットアップ） | - |
| 実寸_股上 | 股上（パンツ/セットアップ） | - |

---

## 8. 技術構成

### 8.1 全体アーキテクチャ

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    LINE     │────▶│   Flask     │────▶│  OpenAI API │
│  (ユーザー)  │◀────│  (Render)   │◀────│  (GPT-4V)   │
└─────────────┘     └──────┬──────┘     └─────────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │   Google    │
                   │ Spreadsheet │
                   └─────────────┘
```

### 8.2 モジュール構成

```
sale_support/
├── app.py                      # Flaskエントリポイント
├── config.py                   # 設定・環境変数管理
├── requirements.txt            # 依存ライブラリ
├── .env                        # 環境変数（Git管理外）
├── .env.example                # 環境変数テンプレート
│
├── core/                       # コアロジック
│   ├── __init__.py
│   ├── image_analyzer.py       # 画像＋テキスト → 特徴JSON
│   ├── text_parser.py          # テキスト入力のパース（実寸等）
│   ├── feature_refiner.py      # ユーザー修正の反映
│   ├── description_generator.py # テンプレート適用・説明文生成
│   ├── pricing.py              # 価格計算ロジック
│   └── prompts.py              # AIプロンプト定義
│
├── integrations/               # 外部サービス連携
│   ├── __init__.py
│   ├── line_handler.py         # LINE Messaging API
│   ├── openai_client.py        # OpenAI API クライアント
│   └── sheets_client.py        # Google Sheets API
│
├── models/                     # データモデル
│   ├── __init__.py
│   └── product.py              # 商品データクラス
│
├── templates/                  # 商品説明テンプレート
│   ├── tops.txt
│   ├── pants.txt
│   └── setup.txt
│
├── tests/                      # テスト
│   └── ...
│
└── docs/                       # ドキュメント
    └── requirements.md         # この要件定義書
```

### 8.3 環境変数

```env
# OpenAI
OPENAI_API_KEY=sk-...

# LINE Messaging API
LINE_CHANNEL_ACCESS_TOKEN=...
LINE_CHANNEL_SECRET=...

# Google Sheets
GOOGLE_SHEETS_CREDENTIALS={"type": "service_account", ...}  # JSON文字列
SPREADSHEET_ID=...

# アプリケーション設定
SHIPPING_COST=500
MINIMUM_PROFIT=200
```

### 8.4 依存ライブラリ

```
flask>=3.0.0
gunicorn>=21.0.0
line-bot-sdk>=3.0.0
openai>=1.0.0
gspread>=5.0.0
google-auth>=2.0.0
python-dotenv>=1.0.0
Pillow>=10.0.0
```

---

## 9. 開発ステップ

### Step 1: コアロジック（ローカル動作）
- [x] 要件定義
- [ ] テキストパーサー（実寸・仕入れ値の抽出）
- [ ] OpenAI Vision API連携（画像→特徴JSON）
- [ ] 商品説明テンプレート適用
- [ ] 価格計算ロジック
- [ ] ローカルテスト用CLI

**成果物**：画像パス＋テキスト → 商品情報JSON を返すPythonスクリプト

### Step 2: LINE連携
- [ ] LINE Webhook設定
- [ ] 画像受信・保存処理
- [ ] セッション管理（確認→修正フロー）
- [ ] 返信メッセージフォーマット

**成果物**：LINEで画像＋テキスト送信 → 確認 → 生成結果返信

### Step 3: Googleスプレッドシート連携
- [ ] Google Sheets API設定
- [ ] 書き込み処理
- [ ] エラーハンドリング

**成果物**：生成結果がスプレッドシートに自動保存

### Step 4: Renderデプロイ
- [ ] 環境変数設定
- [ ] デプロイ設定
- [ ] 動作確認

**成果物**：本番環境で動作するシステム

### Step 5: 機能拡張（将来）
- [ ] 販売データを活用した価格提案の高度化
- [ ] 画像のGoogle Drive保存
- [ ] 販売履歴との連携
- [ ] 複数商品の並行処理

---

## 10. 制約・注意事項

1. **1ユーザー1商品ずつ**の処理（並行処理は将来対応）
2. **画像保存はv1では対象外**（スプレッドシートへの保存は将来対応）
3. **価格はAI推測ベース**（v1では精度保証なし、参考値として扱う）
4. **テンプレートの固定部分は変更しない**（状態説明・注意書き等）
5. **素材はタグから読み取れた場合のみ記載**（読み取れない場合は省略）
